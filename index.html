<script>
    const urlScript = 'https://script.google.com/macros/s/AKfycbynkTaK1tjzlvroQQXrOnQlyCFKFWZQ53mkkqzXewQedhOsA70LVkHRlnSF33dbP9hk/exec'; 
    let barberoActual = ""; 
    let fechaGlobal = new Date().toISOString().split('T')[0];
    let turnoGlobal = 'mañana';
    let horaGlobal = '';
    let horariosOcupados = [];
    let cierresHoy = []; // Nueva: detecta bloqueos del administrador

    window.onload = async () => {
        setupDraggableScroll();
        renderizarCalendario();
        await inicializarEquipo();
        cargarHorarios(fechaGlobal);
    };

    // FUNCIÓN PARA QUE EL SCROLL FUNCIONE EN PC (CLICK Y ARRASTRE)
    function setupDraggableScroll() {
        const containers = ['date-scroll', 'barber-scroll'];
        containers.forEach(id => {
            const slider = document.getElementById(id);
            if(!slider) return;
            let isDown = false; let startX; let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true; slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => { isDown = false; });
            slider.addEventListener('mouseup', () => { isDown = false; });
            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2;
                slider.scrollLeft = scrollLeft - walk;
            });
        });
    }

    async function inicializarEquipo() {
        try {
            const res = await fetch(`${urlScript}?action=getAppointments`);
            const data = await res.json();
            const barberos = data.barberos || [];
            const scroll = document.getElementById('barber-scroll');
            scroll.innerHTML = '';

            if (barberos.length > 0) {
                document.getElementById('section-barbero').classList.remove('hidden');
                barberos.forEach((b, i) => {
                    const card = document.createElement('div');
                    card.className = `barber-card flex-shrink-0 px-6 py-4 rounded-xl flex flex-col items-center ${i === 0 ? 'active' : ''}`;
                    card.innerHTML = `<span class="text-[10px] font-800 uppercase italic">${b[0]}</span>`;
                    if(i === 0) barberoActual = b[0];
                    card.onclick = () => {
                        document.querySelectorAll('.barber-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        barberoActual = b[0];
                        cargarHorarios(fechaGlobal);
                    };
                    scroll.appendChild(card);
                });
            }
        } catch (e) { console.error(e); barberoActual = "Óscar Mejicanos"; }
    }

    function renderizarCalendario() {
        const scroll = document.getElementById('date-scroll');
        const mesDisplay = document.getElementById('display-mes');
        const hoy = new Date();
        const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dias = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
        mesDisplay.innerText = `${meses[hoy.getMonth()]} ${hoy.getFullYear()}`;

        for(let i=0; i<14; i++) {
            const f = new Date(); f.setDate(hoy.getDate() + i);
            const iso = f.toISOString().split('T')[0];
            const card = document.createElement('div');
            card.className = `date-card flex-shrink-0 w-14 py-4 rounded-xl flex flex-col items-center ${iso === fechaGlobal ? 'active' : ''}`;
            card.innerHTML = `<span class="text-[9px] uppercase font-bold mb-1">${dias[f.getDay()]}</span><span class="text-lg font-800">${f.getDate()}</span>`;
            card.onclick = () => {
                document.querySelectorAll('.date-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                fechaGlobal = iso; cargarHorarios(iso);
            };
            scroll.appendChild(card);
        }
    }

    async function cargarHorarios(fechaSel) {
        const grid = document.getElementById('time-grid');
        if(new Date(fechaSel).getDay() === 0) {
            grid.innerHTML = '<p class="col-span-4 text-center py-4 text-[9px] uppercase font-bold text-gray-400 italic">DOMINGOS CERRADO</p>';
            return;
        }
        grid.innerHTML = '<p class="col-span-4 text-center py-4 text-[10px] uppercase font-bold text-gray-300 animate-pulse">Comprobando agenda...</p>';
        
        try {
            // El backend debe devolver tanto ocupados como cierres
            const res = await fetch(`${urlScript}?fecha=${fechaSel}&barbero=${encodeURIComponent(barberoActual)}`);
            const data = await res.json();
            horariosOcupados = data.ocupados || [];
            cierresHoy = data.cierres || []; // Array con ["Mañana", "Tarde", "Día Completo"]
            renderizarHoras();
        } catch (e) { console.error(e); }
    }

    function setTurno(turno) {
        turnoGlobal = turno;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${turno === 'mañana' ? 'manana' : 'tarde'}`).classList.add('active');
        renderizarHoras();
    }

    function renderizarHoras() {
        const grid = document.getElementById('time-grid');
        const f = new Date(fechaGlobal);
        grid.innerHTML = '';

        // 1. RESTRICCIÓN DÍA COMPLETO
        if(cierresHoy.includes("Día Completo")) {
            grid.innerHTML = '<div class="col-span-4 py-8 px-4 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl text-center"><p class="text-[12px] font-800 uppercase tracking-widest text-black">ESTABLECIMIENTO CERRADO</p></div>';
            return;
        }

        // 2. RESTRICCIÓN SÁBADOS TARDE
        if(f.getDay() === 6 && turnoGlobal === 'tarde') {
            grid.innerHTML = '<p class="col-span-4 text-center py-4 text-[9px] uppercase font-bold text-gray-400 italic">CERRADO SÁBADOS TARDE</p>';
            return;
        }

        // 3. RESTRICCIÓN TURNO BLOQUEADO POR ADMIN
        const turnoNombre = turnoGlobal === 'mañana' ? "Mañana" : "Tarde";
        if(cierresHoy.includes(turnoNombre)) {
            grid.innerHTML = `<div class="col-span-4 py-6 px-4 bg-gray-50 rounded-xl text-center border border-gray-100"><p class="text-[10px] font-800 uppercase tracking-widest text-gray-400 italic">TURNO DE ${turnoNombre.toUpperCase()} CERRADO</p></div>`;
            return;
        }

        const mañana = ["10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30"];
        const tarde = ["16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00"];
        const rango = turnoGlobal === 'mañana' ? mañana : tarde;
        const ahora = new Date(); const hoyIso = ahora.toISOString().split('T')[0];
        const minAhora = (ahora.getHours() * 60) + ahora.getMinutes();

        rango.forEach(h => {
            const [h_h, h_m] = h.split(':').map(Number);
            const chip = document.createElement('button');
            chip.className = `time-chip py-3 text-[11px] font-bold rounded-lg ${h === horaGlobal ? 'active' : ''}`;
            chip.innerText = h;
            chip.disabled = horariosOcupados.includes(h) || (fechaGlobal === hoyIso && (h_h * 60 + h_m) <= minAhora + 20);
            chip.onclick = () => {
                document.querySelectorAll('.time-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active'); horaGlobal = h;
            };
            grid.appendChild(chip);
        });
    }

    async function confirmarCita() {
        const btn = document.getElementById('btn-reserva');
        const d = {
            nombre: document.getElementById('nombre').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            servicio: document.getElementById('servicio').value,
            fecha: fechaGlobal,
            hora: horaGlobal,
            barbero: barberoActual,
            email: document.getElementById('email').value.trim()
        };
        if(!d.nombre || !d.telefono || !d.hora || !d.email) return alert("Completa todos los pasos.");
        
        btn.innerText = "PROCESANDO..."; btn.disabled = true;
        try {
            await fetch(urlScript, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
            document.getElementById('res-barbero').innerText = d.barbero;
            document.getElementById('res-servicio').innerText = d.servicio;
            document.getElementById('res-fecha').innerText = d.fecha;
            document.getElementById('res-hora').innerText = d.hora;
            document.getElementById('vista-formulario').classList.add('hidden');
            document.getElementById('vista-exito').classList.remove('hidden');
            document.getElementById('btn-whatsapp').href = `https://wa.me/34640080146?text=${encodeURIComponent('Hola, tengo una cita con '+d.barbero+' el '+d.fecha+' a las '+d.hora)}`;
        } catch (e) { alert("Error"); btn.disabled = false; btn.innerText = "Confirmar Reserva"; }
    }
</script>
