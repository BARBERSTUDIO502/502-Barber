<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <title>502 Barber Studio - Admin Control</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #fcfcfc; color: #000; }
        .card-admin { background: white; border: 1px solid #000; }
        .tab-btn { border: 1px solid #e5e7eb; border-bottom: 1px solid black; background: #f3f4f6; color: #9ca3af; transition: all 0.2s; position: relative; top: 1px; }
        .tab-active { background: white !important; color: black !important; font-weight: 800; border: 1px solid black !important; border-bottom: 2px solid white !important; border-top: 4px solid black !important; z-index: 10; }
        .subtab-active { border-bottom: 2px solid black; color: black; font-weight: 800; }
        input, select, textarea { border-bottom: 1px solid black !important; outline: none; background: transparent; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 50; }
        .modal-content { box-shadow: 15px 15px 0px 0px rgba(0,0,0,1); border: 2px solid black; animation: modalSlide 0.3s ease-out; }
        @keyframes modalSlide { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Ajuste para evitar desbordamiento en móvil */
        .actions-cell { min-width: 110px; }
    </style>
</head>
<body class="p-2 md:p-10">

    <div id="modal-ficha" class="hidden fixed inset-0 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white modal-content w-full max-w-lg p-8">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="ficha-nombre" class="text-2xl font-800 italic uppercase">Cargando...</h2>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Notas Técnicas del Cliente</p>
                </div>
                <button onclick="cerrarModal('modal-ficha')" class="text-2xl">✕</button>
            </div>
            <textarea id="ficha-notas" rows="6" class="w-full border-l-4 border-black bg-gray-50 p-4 text-sm font-medium mb-6" placeholder="Añade notas sobre el corte..."></textarea>
            <button onclick="guardarNotas()" class="w-full bg-black text-white py-4 font-800 uppercase text-xs tracking-widest hover:bg-gray-800 transition-all">Guardar Notas</button>
        </div>
    </div>

    <div id="modal-edit" class="hidden fixed inset-0 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white modal-content w-full max-w-md p-8">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-800 italic uppercase">Reagendar Cita</h2>
                <button onclick="cerrarModal('modal-edit')" class="text-2xl">✕</button>
            </div>
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-barbero-actual">
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-800 uppercase block mb-1 text-gray-500">Nueva Fecha</label>
                    <input type="date" id="edit-fecha" class="w-full py-2 font-bold" onchange="validarDisponibilidadEdit()">
                </div>
                <div>
                    <label class="text-[10px] font-800 uppercase block mb-1 text-gray-500">Nueva Hora</label>
                    <select id="edit-hora" class="w-full py-2 font-bold bg-white" onchange="validarDisponibilidadEdit()">
                        </select>
                </div>
                <div id="edit-aviso" class="text-[10px] font-bold text-red-500 uppercase hidden italic">⚠️ Horario no disponible o bloqueado</div>
            </div>
            <button id="btn-confirmar-edit" onclick="confirmarEdicion()" class="w-full bg-black text-white py-4 mt-8 font-800 uppercase text-xs hover:bg-gray-800 transition-all">Actualizar Reserva</button>
        </div>
    </div>

    <div class="max-w-5xl mx-auto fade-in">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 border-b-2 border-black pb-8 px-2 gap-4">
            <div>
                <h1 class="text-4xl md:text-6xl font-800 tracking-tighter uppercase leading-none italic">502 BARBER STUDIO</h1>
                <p class="text-[10px] uppercase tracking-[0.4em] text-gray-400 font-bold mt-2">GESTIÓN PROFESIONAL</p>
            </div>
            <div class="flex flex-col items-end gap-1">
                <button onclick="cargarAgenda(true)" class="bg-black text-white px-6 py-2 font-bold text-[10px] uppercase hover:bg-gray-800 transition-all shadow-md">Sincronizar Datos</button>
                <span id="last-update" class="text-[8px] text-gray-400 font-bold uppercase"></span>
            </div>
        </header>

        <div class="grid grid-cols-3 gap-2 md:gap-6 mb-10 text-center">
            <div class="card-admin p-4"><p id="total-citas" class="text-2xl md:text-4xl font-800 italic">0</p><p class="text-[8px] uppercase text-gray-400">Citas Hoy</p></div>
            <div class="card-admin p-4 bg-black text-white shadow-xl"><p id="ingresos-hoy" class="text-2xl md:text-4xl font-800 italic">0€</p><p class="text-[8px] uppercase text-gray-500">Caja Hoy</p></div>
            <div class="card-admin p-4 border-dashed"><p id="proxima-cita" class="text-2xl md:text-4xl font-800 underline">--</p><p class="text-[8px] uppercase text-gray-400">Siguiente</p></div>
        </div>

        <nav class="flex mb-6 overflow-x-auto no-scrollbar gap-1">
            <button id="main-tab-citas" onclick="switchMainTab('citas')" class="tab-btn px-10 py-4 text-[11px] font-bold uppercase tracking-widest tab-active">Citas</button>
            <button id="main-tab-calendario" onclick="switchMainTab('calendario')" class="tab-btn px-10 py-4 text-[11px] font-bold uppercase tracking-widest">Calendario</button>
            <button id="main-tab-equipo" onclick="switchMainTab('equipo')" class="tab-btn px-10 py-4 text-[11px] font-bold uppercase tracking-widest">Equipo</button>
        </nav>

        <div id="loading" class="hidden p-10 text-center uppercase text-[10px] text-gray-400 animate-pulse font-bold italic">Sincronizando con la nube...</div>

        <section id="section-citas" class="fade-in bg-white border border-black p-4">
            <div class="flex flex-wrap items-center gap-4 mb-6 px-2 text-[10px] font-bold uppercase text-gray-400">
                <div class="flex gap-4">
                    <button id="subtab-hoy" onclick="cambiarFiltro('hoy')" class="subtab-active pb-1">Hoy</button>
                    <button id="subtab-futuro" onclick="cambiarFiltro('futuro')" class="pb-1">Próximos</button>
                    <button id="subtab-pasado" onclick="cambiarFiltro('pasado')" class="pb-1">Pasados</button>
                </div>
                <div id="rango-pasados" class="hidden flex flex-wrap gap-2 items-center bg-gray-50 p-2 border ml-auto">
                    <input type="date" id="fecha-desde" class="text-[10px] font-bold">
                    <span>a</span>
                    <input type="date" id="fecha-hasta" class="text-[10px] font-bold">
                    <button onclick="renderizarCitas()" class="bg-black text-white px-4 py-2 font-bold uppercase">Filtrar</button>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-left table-auto"><tbody id="lista-citas" class="divide-y divide-gray-100"></tbody></table></div>
        </section>

        <section id="section-calendario" class="hidden fade-in bg-white border border-black p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="card-admin p-6 h-fit border-dashed bg-gray-50/50">
                    <h4 class="text-xs font-800 uppercase mb-6 border-b-2 border-black pb-2 italic">Bloquear Jornada</h4>
                    <div class="space-y-6">
                        <div><label class="text-[9px] uppercase font-bold text-gray-400 block mb-1">Barbero</label><select id="cierre-barbero" class="w-full py-2 font-bold italic"></select></div>
                        <div><label class="text-[9px] uppercase font-bold text-gray-400 block mb-1">Fecha</label><input type="date" id="cierre-fecha" class="w-full py-2 font-bold"></div>
                        <div class="space-y-2 pt-2">
                            <button onclick="intentarGuardarBloqueo('Mañana')" class="w-full border border-black py-2 text-[9px] font-bold uppercase hover:bg-black hover:text-white transition-all">Mañana</button>
                            <button onclick="intentarGuardarBloqueo('Tarde')" class="w-full border border-black py-2 text-[9px] font-bold uppercase hover:bg-black hover:text-white transition-all">Tarde</button>
                            <button onclick="intentarGuardarBloqueo('Día Completo')" class="w-full border border-black py-2 text-[9px] font-bold uppercase hover:bg-black hover:text-white transition-all">Todo el Día</button>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <h4 class="text-[10px] font-800 uppercase mb-4 text-gray-400 tracking-widest italic">Bloqueos Confirmados</h4>
                    <div id="lista-cierres" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <section id="section-equipo" class="hidden fade-in bg-white border border-black p-6">
            <div class="max-w-2xl">
                <div class="card-admin p-8 mb-8 border-dashed">
                    <h4 class="text-xs font-800 uppercase mb-4 italic">Alta de Barberos</h4>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="new-barber-name" placeholder="Nombre completo" class="flex-1 py-2 text-sm uppercase font-bold">
                        <button onclick="nuevoBarbero()" class="bg-black text-white px-8 py-2 text-[10px] font-bold uppercase">Añadir</button>
                    </div>
                </div>
                <div id="lista-barberos" class="space-y-3"></div>
            </div>
        </section>
    </div>

    <script>
        const urlScript = 'https://script.google.com/macros/s/AKfycbynkTaK1tjzlvroQQXrOnQlyCFKFWZQ53mkkqzXewQedhOsA70LVkHRlnSF33dbP9hk/exec'; 
        let todasLasCitas = [], todosLosBarberos = [], todosLosCierres = [];
        let filtroCitas = 'hoy';
        const precios = { "Corte y lavado": 13, "Corte + barba": 17, "Arreglo barba": 7 };
        let currentClientEditId = null;

        const horasDisponibles = ["10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00"];

        window.onload = () => {
            const pass = prompt("Acceso 502:");
            if(pass === "502admin") {
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fecha-desde').value = hoy;
                document.getElementById('fecha-hasta').value = hoy;
                document.getElementById('cierre-fecha').value = hoy;
                
                // Cargar horas en select edit
                const selectHora = document.getElementById('edit-hora');
                horasDisponibles.forEach(h => {
                    let opt = document.createElement('option');
                    opt.value = h; opt.innerText = h;
                    selectHora.appendChild(opt);
                });

                const cache = localStorage.getItem('barber502Cache');
                if(cache) { procesarDatos(JSON.parse(cache)); }
                cargarAgenda(false);
            } else document.body.innerHTML = "Denegado";
        };

        function normalizeDate(dateStr) {
            if (!dateStr) return "";
            if (dateStr.includes('/')) {
                const [d, m, y] = dateStr.split(' ')[0].split('/');
                return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }
            return dateStr.split('T')[0];
        }

        function formatFechaLarga(dateStr) {
            const fecha = new Date(normalizeDate(dateStr) + "T12:00:00");
            return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }

        function abrirFicha(id, nombre, notas) {
            currentClientEditId = id;
            document.getElementById('ficha-nombre').innerText = nombre;
            document.getElementById('ficha-notas').value = (notas && notas !== 'undefined') ? notas : "";
            document.getElementById('modal-ficha').classList.remove('hidden');
        }

        function abrirEditor(id, fecha, hora, barbero) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-barbero-actual').value = barbero;
            document.getElementById('edit-fecha').value = normalizeDate(fecha);
            document.getElementById('edit-hora').value = hora;
            document.getElementById('modal-edit').classList.remove('hidden');
            validarDisponibilidadEdit();
        }

        function validarDisponibilidadEdit() {
            const fecha = document.getElementById('edit-fecha').value;
            const hora = document.getElementById('edit-hora').value;
            const barbero = document.getElementById('edit-barbero-actual').value;
            const aviso = document.getElementById('edit-aviso');
            const btn = document.getElementById('btn-confirmar-edit');

            // 1. Verificar bloqueos (cierres)
            const bloqueado = todosLosCierres.some(c => {
                const fCierre = normalizeDate(c[0]);
                if (fCierre !== fecha || c[1] !== barbero) return false;
                if (c[4] === "Día Completo") return true;
                const hNum = parseInt(hora.replace(':',''));
                if (c[4] === "Mañana" && hNum < 1500) return true;
                if (c[4] === "Tarde" && hNum >= 1500) return true;
                return false;
            });

            // 2. Verificar si ya hay cita a esa hora (excepto la actual)
            const ocupado = todasLasCitas.some(c => 
                normalizeDate(c[5]) === fecha && 
                c[6] === hora && 
                c[8] === barbero && 
                c[7] !== document.getElementById('edit-id').value &&
                !String(c[1]).includes("CANCELADA")
            );

            if (bloqueado || ocupado) {
                aviso.classList.remove('hidden');
                btn.disabled = true;
                btn.classList.add('opacity-50');
            } else {
                aviso.classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function confirmarEdicion() {
            const id = document.getElementById('edit-id').value;
            const fecha = document.getElementById('edit-fecha').value;
            const hora = document.getElementById('edit-hora').value;
            document.getElementById('loading').classList.remove('hidden');
            cerrarModal('modal-edit');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'editAppointment', eventId: id, fecha: fecha, hora: hora }) });
            cargarAgenda();
        }

        async function guardarNotas() {
            const notas = document.getElementById('ficha-notas').value;
            document.getElementById('loading').classList.remove('hidden');
            cerrarModal('modal-ficha');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'updateNotes', eventId: currentClientEditId, notas: notas }) });
            cargarAgenda();
        }

        function abrirWhatsApp(telefono) {
            const num = String(telefono).replace(/\D/g, '');
            window.open(`https://wa.me/${num.startsWith('34') ? num : '34'+num}`, '_blank');
        }

        async function cargarAgenda(showLoading = true) {
            if(showLoading) document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(`${urlScript}?action=getAppointments`);
                const data = await res.json();
                localStorage.setItem('barber502Cache', JSON.stringify(data));
                procesarDatos(data);
                document.getElementById('last-update').innerText = "VISTO: " + new Date().toLocaleTimeString();
            } catch (e) { console.error(e); }
            document.getElementById('loading').classList.add('hidden');
        }

        function procesarDatos(data) {
            todasLasCitas = data.citas || [];
            todosLosBarberos = data.barberos || [];
            todosLosCierres = data.cierres || [];
            renderizarTodo();
        }

        function renderizarTodo() {
            renderizarCitas();
            renderizarCalendario();
            renderizarEquipo();
        }

        function renderizarCitas() {
            const hoyStr = new Date().toISOString().split('T')[0];
            const validas = todasLasCitas.filter(c => !String(c[1]).includes("CANCELADA"));
            
            // CAJA HOY (Cálculo corregido: todas las del día actual no canceladas)
            const hoyCitas = validas.filter(c => normalizeDate(c[5]) === hoyStr);
            let totalCaja = 0;
            hoyCitas.forEach(c => { 
                const servKey = String(c[3]).trim();
                totalCaja += precios[servKey] || 0; 
            });
            document.getElementById('ingresos-hoy').innerText = totalCaja + "€";
            document.getElementById('total-citas').innerText = hoyCitas.length;
            
            const ahoraHora = new Date().toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit', hour12:false});
            const proximas = hoyCitas.filter(c => c[6] >= ahoraHora).sort((a,b)=>a[6].localeCompare(b[6]));
            document.getElementById('proxima-cita').innerText = proximas.length > 0 ? proximas[0][6] : "--";

            let filtered = [];
            if(filtroCitas === 'hoy') filtered = hoyCitas;
            else if(filtroCitas === 'futuro') filtered = validas.filter(c => normalizeDate(c[5]) > hoyStr);
            else if(filtroCitas === 'pasado') {
                const d = document.getElementById('fecha-desde').value;
                const h = document.getElementById('fecha-hasta').value;
                filtered = validas.filter(c => { const fc = normalizeDate(c[5]); return fc >= d && fc <= h; });
            }
            
            filtered.sort((a,b) => normalizeDate(a[5]).localeCompare(normalizeDate(b[5])) || a[6].localeCompare(b[6]));

            document.getElementById('lista-citas').innerHTML = filtered.map(c => {
                const notasLimpias = c[4] ? String(c[4]).replace(/'/g, "\\'") : "";
                const barbero = c[8] || 'Óscar';
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="p-2 md:p-4 font-800 text-lg md:text-xl italic w-20 md:w-24">${c[6]}</td>
                    <td class="p-2 md:p-4">
                        <button onclick="abrirFicha('${c[7]}','${c[1]}','${notasLimpias}')" class="text-[11px] md:text-[12px] font-800 uppercase hover:underline text-left block leading-tight mb-1">${c[1]}</button>
                        <span class="text-[10px] font-bold uppercase text-black block mb-0.5">${c[3]}</span>
                        <span class="text-[8px] text-gray-400 font-bold uppercase block">${formatFechaLarga(c[5])} · ${barbero}</span>
                    </td>
                    <td class="p-2 md:p-4 text-right actions-cell">
                        <div class="flex gap-2 md:gap-3 justify-end items-center">
                            <button onclick="abrirWhatsApp('${c[2]}')" title="WhatsApp"><svg class="w-5 h-5 fill-green-500" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766 0-3.187-2.575-5.771-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.17.824-.299.045-.677.063-1.092-.069-.252-.08-.575-.187-.988-.365-1.739-.751-2.874-2.512-2.96-2.626-.088-.113-.716-.953-.716-1.819 0-.866.454-1.292.616-1.47.162-.177.353-.222.47-.222s.235.004.338.008c.113.004.264-.043.413.313.144.353.5 1.22.544 1.309.045.089.074.191.015.308-.059.117-.088.19-.176.293l-.265.308c-.088.098-.182.204-.078.382.104.178.461.761.99 1.231.68.605 1.253.793 1.429.882.176.088.279.074.382-.044.103-.117.441-.514.558-.691.117-.176.235-.147.397-.088.162.059 1.029.485 1.206.574.176.088.293.132.338.205.045.074.045.426-.099.831zM12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 21.818c-5.414 0-9.818-4.404-9.818-9.818s4.404-9.818 9.818-9.818 9.818 4.404 9.818 9.818-4.404 9.818-9.818 9.818z"/></svg></button>
                            <button onclick="abrirEditor('${c[7]}', '${c[5]}', '${c[6]}', '${barbero}')" title="Editar"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button onclick="cancelarCita('${c[7]}')" class="text-red-500 border-2 border-red-500 px-1.5 py-0.5 text-[10px] hover:bg-red-500 hover:text-white transition-all font-bold" title="Anular">✕</button>
                        </div>
                    </td>
                </tr>`}).join('') || `<tr><td class="p-10 text-center text-xs text-gray-400 uppercase">Sin citas registradas</td></tr>`;
        }

        function renderizarCalendario() {
            const sel = document.getElementById('cierre-barbero');
            sel.innerHTML = todosLosBarberos.map(b => `<option value="${b[0]}">${b[0]}</option>`).join('');
            document.getElementById('lista-cierres').innerHTML = todosLosCierres.sort((a,b)=>normalizeDate(a[0]).localeCompare(normalizeDate(b[0]))).map(c => `
                <div class="card-admin p-4 flex justify-between items-center bg-white border-l-4 border-l-black">
                    <div><p class="text-[10px] font-800 uppercase italic">${c[1]}</p><p class="text-[9px] font-bold text-gray-400 uppercase">${c[0].split(' ')[0]}</p><p class="text-[8px] bg-black text-white px-2 mt-1 inline-block uppercase font-bold italic">${c[4]}</p></div>
                    <button onclick="borrarCierre('${c[0].split(' ')[0]}','${c[1]}','${c[4]}')" class="text-red-500 font-bold p-2">✕</button>
                </div>`).join('') || `<p class="p-4 text-xs text-gray-400 uppercase">No hay bloqueos</p>`;
        }

        function renderizarEquipo() {
            document.getElementById('lista-barberos').innerHTML = todosLosBarberos.map(b => {
                const nombre = b[0].toLowerCase().trim();
                const esOscar = nombre === "oscar" || nombre === "óscar";
                return `
                <div class="p-4 bg-white border border-black flex justify-between items-center">
                    <span class="font-800 uppercase text-xs italic">${b[0]}</span>
                    ${!esOscar ? `<button onclick="borrarBarbero('${b[0]}')" class="text-[9px] font-bold text-red-500 border border-red-500 px-4 py-1 hover:bg-red-500 hover:text-white uppercase transition-all">Eliminar Barbero</button>` : `<span class="text-[8px] font-bold text-gray-200 uppercase tracking-widest italic px-2">Propietario</span>`}
                </div>`;
            }).join('');
        }

        function switchMainTab(tab) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`main-tab-${tab}`).classList.add('tab-active');
        }

        function cambiarFiltro(f) {
            filtroCitas = f;
            document.querySelectorAll('[id^="subtab-"]').forEach(b => b.classList.remove('subtab-active'));
            document.getElementById('subtab-' + f).classList.add('subtab-active');
            document.getElementById('rango-pasados').classList.toggle('hidden', f !== 'pasado');
            renderizarCitas();
        }

        async function intentarGuardarBloqueo(tipo) {
            const barber = document.getElementById('cierre-barbero').value;
            const fecha = document.getElementById('cierre-fecha').value;
            if(!fecha) return alert("Selecciona fecha");
            document.getElementById('loading').classList.remove('hidden');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'saveClosure', barbero: barber, fecha: fecha, tipo: tipo }) });
            cargarAgenda();
        }

        async function nuevoBarbero() {
            const n = document.getElementById('new-barber-name').value;
            if(!n) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'saveBarber', nombre: n }) });
            document.getElementById('new-barber-name').value = '';
            cargarAgenda();
        }

        async function borrarBarbero(n) {
            if(!confirm(`¿Eliminar a ${n}?`)) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'deleteBarber', nombre: n }) });
            cargarAgenda();
        }

        async function cancelarCita(id) {
            if(!confirm("¿Deseas anular esta reserva?")) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'cancel', eventId: id }) });
            cargarAgenda();
        }

        async function borrarCierre(f, b, t) {
            if(!confirm("¿Reabrir esta jornada?")) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(urlScript, { method: 'POST', body: JSON.stringify({ action: 'deleteClosure', fecha: f, barbero: b, tipo: t }) });
            cargarAgenda();
        }
    </script>
</body>
</html>
